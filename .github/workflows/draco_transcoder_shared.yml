name: draco-transcoder-shared

on:
  workflow_dispatch:
    # Manual trigger only

jobs:
  build-draco-sdk:
    name: build-draco-sdk-${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: checkout-source
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            cmake_generator: "Unix Makefiles"
            cmake_build_args: "-- -j2"
            sdk_target: draco_static
            lib_name: libdraco.a
            package_commands: |
              mkdir -p sdk/lib sdk/include
              cp _gh_sdk_build/libdraco.a sdk/lib/
              cp -r src/draco sdk/include/
              cp _gh_sdk_build/draco/draco_features.h sdk/include/draco/
          - os: windows-latest
            cmake_generator: "Visual Studio 17 2022"
            cmake_build_args: "--config Release"
            sdk_target: draco
            lib_name: draco.lib
            package_commands: |
              mkdir -p sdk/lib sdk/include
              cp _gh_sdk_build/Release/draco.lib sdk/lib/
              cp -r src/draco sdk/include/
              cp _gh_sdk_build/draco/draco_features.h sdk/include/draco/
          - os: macos-latest
            cmake_generator: "Unix Makefiles"
            cmake_build_args: "-- -j2"
            sdk_target: draco_static
            lib_name: libdraco.a
            package_commands: |
              mkdir -p sdk/lib sdk/include
              cp _gh_sdk_build/libdraco.a sdk/lib/
              cp -r src/draco sdk/include/
              cp _gh_sdk_build/draco/draco_features.h sdk/include/draco/
    steps:
      - name: Download source code
        uses: actions/download-artifact@v4
        with:
          name: draco-source

      - name: Configure CMake for Draco SDK
        shell: bash
        run: |
          mkdir _gh_sdk_build && cd _gh_sdk_build
          cmake .. -G "${{ matrix.cmake_generator }}" \
            -DCMAKE_BUILD_TYPE=Release \
            -DDRACO_TRANSCODER_SUPPORTED=ON \
            -DDRACO_BUILD_EXECUTABLES=OFF \
            -DBUILD_SHARED_LIBS=OFF

      - name: Build Draco SDK (static library)
        run: |
          cd _gh_sdk_build
          cmake --build . --target ${{ matrix.sdk_target }} ${{ matrix.cmake_build_args }}

      - name: Create SDK package
        run: ${{ matrix.package_commands }}
        shell: bash

      - name: Upload Draco SDK
        uses: actions/upload-artifact@v4
        with:
          name: draco-sdk-${{ matrix.os }}
          path: sdk/
          retention-days: 7

  checkout-source:
    name: checkout-source
    runs-on: ubuntu-latest
    steps:
      - name: Clone Draco with Submodules
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Upload source code
        uses: actions/upload-artifact@v4
        with:
          name: draco-source
          path: .
          retention-days: 1

  build-shared-lib:
    needs: [checkout-source, build-draco-sdk]
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            container: ubuntu:18.10
            lib_name: libdraco_transcoder_shared.so
            artifact_name: draco-transcoder-ubuntu-18.10
            cmake_configure_command: |
              apt-get update && apt-get install -y build-essential cmake
              mkdir _gh_build && cd _gh_build
              if [ -d "$GITHUB_WORKSPACE/sdk" ]; then
                echo "Using pre-built Draco SDK"
                cmake .. -G "Unix Makefiles" \
                  -DBUILD_SHARED_LIBS=ON \
                  -DCMAKE_BUILD_TYPE=Release \
                  -DDRACO_TRANSCODER_SUPPORTED=ON \
                  -DDRACO_BUILD_EXECUTABLES=OFF \
                  -DDRACO_SDK_PATH="$GITHUB_WORKSPACE/sdk"
              else
                echo "Building with full Draco library"
                cmake .. -G "Unix Makefiles" \
                  -DBUILD_SHARED_LIBS=ON \
                  -DCMAKE_BUILD_TYPE=Release \
                  -DDRACO_TRANSCODER_SUPPORTED=ON \
                  -DDRACO_BUILD_EXECUTABLES=OFF
              fi
            cmake_build_command: cmake --build . --target draco_transcoder_shared -- -j2
          - os: windows-latest
            lib_name: Release/draco_transcoder_shared.dll
            artifact_name: draco-transcoder-windows
            cmake_configure_command: |
              mkdir _gh_build && cd _gh_build
              if [ -d "$GITHUB_WORKSPACE/sdk" ]; then
                echo "Using pre-built Draco SDK"
                cmake .. -G "Visual Studio 17 2022" \
                  -DBUILD_SHARED_LIBS=ON \
                  -DCMAKE_CONFIGURATION_TYPES=Release \
                  -DDRACO_TRANSCODER_SUPPORTED=ON \
                  -DDRACO_BUILD_EXECUTABLES=OFF \
                  -DDRACO_SDK_PATH="$GITHUB_WORKSPACE/sdk"
              else
                echo "Building with full Draco library"
                cmake .. -G "Visual Studio 17 2022" \
                  -DBUILD_SHARED_LIBS=ON \
                  -DCMAKE_CONFIGURATION_TYPES=Release \
                  -DDRACO_TRANSCODER_SUPPORTED=ON \
                  -DDRACO_BUILD_EXECUTABLES=OFF
              fi
            cmake_build_command: cmake --build . --config Release --target draco_transcoder_shared
          - os: macos-latest
            lib_name: libdraco_transcoder_shared.dylib
            artifact_name: draco-transcoder-macos
            cmake_configure_command: |
              mkdir _gh_build && cd _gh_build
              if [ -d "$GITHUB_WORKSPACE/sdk" ]; then
                echo "Using pre-built Draco SDK"
                cmake .. -G "Unix Makefiles" \
                  -DBUILD_SHARED_LIBS=ON \
                  -DCMAKE_BUILD_TYPE=Release \
                  -DDRACO_TRANSCODER_SUPPORTED=ON \
                  -DDRACO_BUILD_EXECUTABLES=OFF \
                  -DDRACO_SDK_PATH="$GITHUB_WORKSPACE/sdk"
              else
                echo "Building with full Draco library"
                cmake .. -G "Unix Makefiles" \
                  -DBUILD_SHARED_LIBS=ON \
                  -DCMAKE_BUILD_TYPE=Release \
                  -DDRACO_TRANSCODER_SUPPORTED=ON \
                  -DDRACO_BUILD_EXECUTABLES=OFF
              fi
            cmake_build_command: cmake --build . --target draco_transcoder_shared -- -j2

    name: build-${{ matrix.artifact_name }}
    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container }}

    steps:
      - name: Download Draco SDK
        uses: actions/download-artifact@v4
        with:
          name: draco-sdk-${{ matrix.os }}
          path: sdk/

      - name: Download source code
        uses: actions/download-artifact@v4
        with:
          name: draco-source

      - name: Fix Ubuntu 18.10 repositories (if needed)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sed -i 's/archive.ubuntu.com/old-releases.ubuntu.com/g' /etc/apt/sources.list
          sed -i 's/security.ubuntu.com/old-releases.ubuntu.com/g' /etc/apt/sources.list

      - name: Configure CMake build
        shell: bash
        run: ${{ matrix.cmake_configure_command }}

      - name: Build with CMake
        shell: bash
        run: ${{ matrix.cmake_build_command }}
        working-directory: ./_gh_build

      - name: Upload shared library
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: _gh_build/${{ matrix.lib_name }}
